### $\text{a}$

分 $v = 0\sim 7$ 来处理，这样每个询问对应的都是一个区间 $[L,R]$，与其的 $[0, D]$ 求交集就是对应答案，时间复杂度 $O(q(n + m))$。

> $dx = 1$，则有 $a2 + d\ge x, a1 + d\le x$，即 $d\in [x - a2, x - a1]$。  
> $dx= -1$，则有 $a2 - d\ge x, a1 - d\le x$，即 $d\in [a1 - x, a2 - x]$。  
> $dy = 1$，则有 $d\in [y - b2, y - b1]$。  
> $dy = -1$，则有 $d\in [b1 - y, b2 - y]$。

对于 $m = 0$ 的，离线然后扫描线。  

对于 $v\in {0, 2, 4, 6}$ 的，可以把不变的一维当作加入删除，也差不多的样子。

#### $\text{marketeers}$

从 $1\sim n$ 遍历，维护 $\max(s_i)$，首先根据 $\max(s_i)$ 求出 $\{j | i < j\le n, \max(s_i)> \min(s_j)\}$，那这些就是要满足的，然后 $\max(s_j)\leftarrow \max(\{x | x\in s_j, x < \max(s_i)\})$，这些 $j\to i$ 连个边，这玩意肯定是个 $\text{DAG}$。   

> 注意建一个虚点 $1\sim n\to 0$，方便统计。

然后大力转移一下就是 $O(n^2\log \sum|s_i|)$ 的，瓶颈在开头的连边和边数 $O(n^2)$，但我暂时不会。  
你说的对，但是怎么转移。  
令 $f_{i, j}$ 为第 $i$ 个点选排完序后第 $j$ 个数的方案数。  
那么对于 $k < i, \max(s_k) > a_{i, j}$ 的就可以填 $j$ 个过去。  
所以还要维护个 $\min(s_k)$，就是至少取到这个值才可以满足后面的。  
然后可以用个前缀积，在对应的一位乘上 $\dfrac{j}{j - 1}$。 
但是这样时间复杂度变为了 $O(n\sum |s_i|\log \sum |s_i|)$。  
这个玩意可以树套树，线段树套动态开点权值线段树，维护 $[l, r]$ 区间内对应的权值即可，时间复杂度应该是 $O(\sum |s_i| \log n\log \sum |s_i|)$，空间复杂度也差不多。

连边的过程似乎只需要一个线段树，可以做到 $O(n\log n + \sum |s_i|)$。

但是重了,对于 $a\to b, a\to c, b\to c$ 的应该不能算 $a\to c$ 的贡献的。

似了。